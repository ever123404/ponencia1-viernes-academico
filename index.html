<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Transporte de Contaminantes | Universidad Nacional de Cajamarca</title>
    <meta name="description" content="Simulaci√≥n Matem√°tica Avanzada - Departamento Acad√©mico de Matem√°tica - UNC">
    
    <!-- Favicon institucional -->
    <link rel="icon" href="./logo-unc.png" type="image/png">
    <link rel="apple-touch-icon" href="./logo-unc.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0c1e3e 0%, #1a365d 30%, #2d5a87 70%, #4299e1 100%);
            min-height: 100vh;
            color: #f7fafc;
            overflow-x: hidden;
        }
        
        .app-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #0c1e3e 0%, #1a365d 30%, #2d5a87 70%, #4299e1 100%);
        }
        
        /* Header Institucional */
        .institutional-header {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #4a5568 100%);
            border-bottom: 4px solid #d69e2e;
            padding: 1rem 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .university-logo {
            width: 110px;
            height: 110px;
            background: #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 12px 28px rgba(214, 158, 46, 0.5);
            flex-shrink: 0;
            border: 4px solid #d69e2e;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .university-logo:hover {
            transform: scale(1.08);
            box-shadow: 0 16px 35px rgba(214, 158, 46, 0.7);
        }
        
        .university-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
            padding: 4px;
            background: #ffffff;
        }
        
        /* Fallback profesional en caso de que la imagen no cargue */
        .fallback-logo {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #d69e2e 0%, #f6ad55 100%);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: #1a202c;
            font-weight: 900;
            text-align: center;
            line-height: 1.1;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        .institutional-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        
        .university-info {
            flex: 1;
            min-width: 300px;
        }
        
        .university-name {
            font-size: 1.5rem;
            font-weight: 800;
            color: #f7fafc;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .department-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #d69e2e;
            margin-bottom: 0.5rem;
        }
        
        .project-title {
            font-size: 0.9rem;
            color: #cbd5e1;
            font-weight: 400;
            line-height: 1.4;
        }
        
        .developer-credit {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-top: 0.5rem;
            font-style: italic;
        }
        
        @media (min-width: 768px) {
            .university-name {
                font-size: 2rem;
            }
            .department-name {
                font-size: 1.25rem;
            }
            .project-title {
                font-size: 1rem;
            }
        }
        
        /* Header Principal */
        .main-header {
            background: rgba(26, 32, 44, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(214, 158, 46, 0.3);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        @media (min-width: 768px) {
            .header-content {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }
        
        .simulation-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .simulation-icon {
            background: linear-gradient(135deg, #3182ce, #2b77cb);
            padding: 1rem;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 8px 20px rgba(49, 130, 206, 0.4);
        }
        
        .simulation-info h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f7fafc;
            margin-bottom: 0.25rem;
            line-height: 1.2;
        }
        
        @media (min-width: 768px) {
            .simulation-info h1 {
                font-size: 1.875rem;
            }
        }
        
        .simulation-subtitle {
            font-size: 0.875rem;
            color: #a0aec0;
            font-weight: 500;
        }
        
        @media (min-width: 768px) {
            .simulation-subtitle {
                font-size: 1rem;
            }
        }
        
        .main-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        @media (min-width: 768px) {
            .main-controls {
                justify-content: flex-end;
            }
        }
        
        .btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.75rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
            text-decoration: none;
            white-space: nowrap;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.15);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: white;
            border: 1px solid rgba(56, 161, 105, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
            border: 1px solid rgba(229, 62, 62, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
            border: 1px solid rgba(74, 85, 104, 0.3);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3182ce, #2c5aa0);
            color: white;
            border: 1px solid rgba(49, 130, 206, 0.3);
        }
        
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .canvas-section {
            background: rgba(26, 32, 44, 0.6);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(214, 158, 46, 0.2);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .section-icon {
            background: linear-gradient(135deg, #d69e2e, #f6ad55);
            color: #1a202c;
            padding: 0.75rem;
            border-radius: 12px;
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f7fafc;
        }
        
        .canvas-container {
            background: linear-gradient(135deg, #1a202c, #2d3748);
            border-radius: 16px;
            padding: 1.5rem;
            border: 2px solid rgba(214, 158, 46, 0.3);
            margin-bottom: 2rem;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        #simulationCanvas {
            width: 100%;
            height: auto;
            border-radius: 12px;
            display: block;
            background: #0f1419;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            transition: cursor 0.2s ease;
        }
        
        .canvas-overlay {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(26, 32, 44, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid rgba(214, 158, 46, 0.3);
            min-width: 200px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .canvas-overlay.active {
            opacity: 1;
        }
        
        .concentration-display {
            font-family: 'Courier New', monospace;
            color: #f7fafc;
        }
        
        .concentration-header {
            font-size: 0.875rem;
            font-weight: 600;
            color: #63b3ed;
            margin-bottom: 0.75rem;
            text-align: center;
            border-bottom: 1px solid rgba(99, 179, 237, 0.3);
            padding-bottom: 0.5rem;
        }
        
        .concentration-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #68d391;
            margin-bottom: 0.75rem;
            text-align: center;
        }
        
        .concentration-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            gap: 1rem;
        }
        
        .concentration-coords, .concentration-time {
            font-size: 0.875rem;
            color: #e2e8f0;
            font-weight: 500;
        }
        
        .concentration-time {
            color: #fbbf24;
        }
        
        .concentration-units {
            font-size: 0.75rem;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(160, 174, 192, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.25rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(45, 55, 72, 0.8), rgba(26, 32, 44, 0.9));
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(214, 158, 46, 0.2);
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(214, 158, 46, 0.4);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            font-family: 'Courier New', monospace;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #a0aec0;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-blue { color: #63b3ed; }
        .stat-green { color: #68d391; }
        .stat-red { color: #fc8181; }
        .stat-yellow { color: #f6ad55; }
        
        .controls-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .control-panel {
            background: rgba(26, 32, 44, 0.6);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(214, 158, 46, 0.2);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }
        
        .control-panel h3 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #f7fafc;
        }
        
        .control-group {
            margin-bottom: 1.5rem;
        }
        
        .control-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #4a5568;
            outline: none;
            appearance: none;
            cursor: pointer;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d69e2e, #f6ad55);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(214, 158, 46, 0.5);
            border: 2px solid #fff;
        }
        
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d69e2e, #f6ad55);
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 4px 12px rgba(214, 158, 46, 0.5);
        }
        
        .info-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .info-panel {
            background: rgba(26, 32, 44, 0.6);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(214, 158, 46, 0.2);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }
        
        .info-panel h3 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #f7fafc;
        }
        
        .equation {
            background: linear-gradient(135deg, #1a202c, #2d3748);
            border-radius: 12px;
            padding: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            color: #e2e8f0;
            border: 1px solid rgba(214, 158, 46, 0.3);
            margin: 1rem 0;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
            text-align: center;
            font-weight: 500;
        }
        
        .phenomena-list {
            list-style: none;
            padding: 0;
        }
        
        .phenomena-list li {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            padding: 0.75rem;
            background: rgba(45, 55, 72, 0.3);
            border-radius: 8px;
            border-left: 4px solid transparent;
        }
        
        .phenomena-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .dot-green { 
            background: #68d391; 
        }
        .dot-blue { 
            background: #63b3ed; 
        }
        .dot-yellow { 
            background: #f6ad55; 
        }
        .dot-red { 
            background: #fc8181; 
        }
        
        .phenomena-list li:nth-child(1) { border-left-color: #68d391; }
        .phenomena-list li:nth-child(2) { border-left-color: #63b3ed; }
        .phenomena-list li:nth-child(3) { border-left-color: #f6ad55; }
        .phenomena-list li:nth-child(4) { border-left-color: #fc8181; }
        
        /* Panel de An√°lisis de Concentraci√≥n */
        .concentration-panel {
            background: rgba(26, 32, 44, 0.6);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(99, 179, 237, 0.3);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 2rem;
        }
        
        .concentration-panel h3 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #f7fafc;
        }
        
        .concentration-mode-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .mode-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            background: rgba(45, 55, 72, 0.5);
            color: #a0aec0;
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #3182ce, #2c5aa0);
            color: white;
            border-color: rgba(49, 130, 206, 0.5);
        }
        
        .concentration-instructions {
            padding: 1rem;
            background: rgba(49, 130, 206, 0.1);
            border-radius: 8px;
            border-left: 4px solid #3182ce;
            font-size: 0.875rem;
            color: #cbd5e1;
            line-height: 1.5;
        }
        
        /* Footer Acad√©mico */
        .academic-footer {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: #a0aec0;
            padding: 3rem 1rem 2rem;
            border-top: 3px solid #d69e2e;
            margin-top: 3rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .footer-section h4 {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #f7fafc;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .footer-section p, .footer-section li {
            font-size: 0.875rem;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }
        
        .footer-section ul {
            list-style: none;
            padding: 0;
        }
        
        .footer-section ul li:before {
            content: "‚ñ∏";
            color: #d69e2e;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .copyright {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(214, 158, 46, 0.2);
            font-size: 0.8rem;
            color: #718096;
        }
        
        /* Indicador de estado del logo */
        .logo-status {
            position: absolute;
            bottom: -3px;
            right: -3px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #48bb78;
            border: 3px solid #ffffff;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .logo-loaded .logo-status {
            opacity: 1;
        }
        
        .logo-error .logo-status {
            background: #f56565;
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .institutional-content {
                flex-direction: column;
                text-align: center;
            }
            
            .university-logo {
                width: 95px;
                height: 95px;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .controls-section {
                grid-template-columns: 1fr;
            }
            
            .info-section {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .main-controls {
                width: 100%;
                justify-content: center;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
                min-width: 140px;
                font-size: 0.8rem;
                padding: 0.75rem 1.25rem;
            }
            
            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .concentration-details {
                flex-direction: column;
                gap: 0.25rem;
            }
            
            .canvas-overlay {
                position: static;
                margin-top: 1rem;
                opacity: 1;
            }
            
            .concentration-mode-toggle {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            #clearPointBtn {
                margin-left: 0 !important;
                width: 100%;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        
        /* Animaci√≥n de carga del logo */
        @keyframes logoPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .logo-loading {
            animation: logoPulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="app-container animate-fade-in" id="app">
        <!-- Header Institucional -->
        <header class="institutional-header">
            <div class="institutional-content">
                <div class="university-logo logo-loading" id="universityLogo">
                    <!-- Logo institucional oficial -->
                    <img src="./logo-unc.png" 
                         alt="Logo Universidad Nacional de Cajamarca" 
                         id="logoImage"
                         loading="eager"
                         onerror="handleLogoError(this)"
                         onload="handleLogoLoad(this)">
                    
                    <!-- Fallback profesional -->
                    <div class="fallback-logo" id="fallbackLogo">
                        <div>
                            <div style="font-size: 0.6rem; margin-bottom: 2px; opacity: 0.8;">UNIVERSIDAD</div>
                            <div style="font-size: 1.4rem; font-weight: 900; margin: 2px 0;">UNC</div>
                            <div style="font-size: 1.1rem; margin: 2px 0;">üèõÔ∏è</div>
                            <div style="font-size: 0.6rem; margin-top: 2px; opacity: 0.8;">CAJAMARCA</div>
                        </div>
                    </div>
                    
                    <!-- Indicador de estado -->
                    <div class="logo-status" id="logoStatus"></div>
                </div>
                
                <div class="university-info">
                    <h1 class="university-name">Universidad Nacional de Cajamarca</h1>
                    <h2 class="department-name">Departamento Acad√©mico de Matem√°tica</h2>
                    <p class="project-title">Simulador de Transporte de Contaminantes en Medios Acu√°ticos | Investigaci√≥n en Matem√°tica Aplicada</p>
                    <p class="developer-credit">
                        <strong>Desarrollado por:</strong> Ever Rojas Huam√°n | Modelado Matem√°tico Avanzado
                    </p>
                </div>
            </div>
        </header>

        <!-- Header Principal -->
        <header class="main-header">
            <div class="header-content">
                <div class="simulation-title">
                    <div class="simulation-icon">
                        üåä
                    </div>
                    <div class="simulation-info">
                        <h1>Modelado Matem√°tico de Transporte de Contaminantes</h1>
                        <p class="simulation-subtitle">Simulaci√≥n Num√©rica Avanzada | M√©todo de Elementos Finitos | Ecuaciones Diferenciales Parciales</p>
                    </div>
                </div>
                
                <div class="main-controls">
                    <button id="startBtn" class="btn btn-primary">
                        ‚ñ∂Ô∏è Iniciar Simulaci√≥n
                    </button>
                    
                    <button id="concentrationBtn" class="btn btn-info">
                        üìä An√°lisis C(x,y,t)
                    </button>
                    
                    <button id="resetBtn" class="btn btn-secondary">
                        üîÑ Reiniciar Modelo
                    </button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- Panel de An√°lisis de Concentraci√≥n -->
            <section class="concentration-panel" id="concentrationPanel" style="display: none;">
                <div class="section-header">
                    <div class="section-icon">üìä</div>
                    <h3 class="section-title">An√°lisis Cuantitativo de la Variable C(x,y,t)</h3>
                </div>
                
                <div class="concentration-mode-toggle">
                    <button class="mode-btn active" data-mode="point">
                        üéØ Consulta Puntual
                    </button>
                    <button class="mode-btn" data-mode="profile">
                        üìà Perfil Longitudinal
                    </button>
                    <button class="mode-btn" data-mode="cross">
                        üìä Perfil Transversal
                    </button>
                    <button class="btn btn-secondary" id="clearPointBtn" style="margin-left: auto; padding: 0.5rem 1rem; font-size: 0.8rem;">
                        üóëÔ∏è Limpiar Selecci√≥n
                    </button>
                </div>
                
                <div class="concentration-instructions">
                    <strong>Modo Activo:</strong> <span id="currentModeText">Consulta Puntual</span><br>
                    <strong>Instrucciones:</strong> <span id="instructionText">Haga clic en cualquier punto del dominio de simulaci√≥n para obtener el valor de concentraci√≥n C(x,y,t) en esa ubicaci√≥n espec√≠fica.</span>
                </div>
            </section>

            <!-- Secci√≥n del Canvas -->
            <section class="canvas-section">
                <div class="section-header">
                    <div class="section-icon">üìä</div>
                    <h2 class="section-title">Visualizaci√≥n de la Simulaci√≥n</h2>
                </div>
                
                <div class="canvas-container">
                    <canvas id="simulationCanvas" width="1200" height="600"></canvas>
                    
                    <!-- Overlay para mostrar informaci√≥n completa de C(x,y,t) -->
                    <div class="canvas-overlay" id="concentrationOverlay">
                        <div class="concentration-display">
                            <div class="concentration-header">
                                <strong>üìç An√°lisis Puntual C(x,y,t)</strong>
                            </div>
                            <div class="concentration-value" id="pointConcentration">0.000 mg/L</div>
                            <div class="concentration-details">
                                <div class="concentration-coords" id="pointCoordinates">x: 0.0m, y: 0.0m</div>
                                <div class="concentration-time" id="pointTime">t: 0.0s</div>
                            </div>
                            <div class="concentration-units">Concentraci√≥n del Contaminante</div>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value stat-blue" id="timeValue">0.0s</div>
                            <div class="stat-label">Tiempo de Simulaci√≥n</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value stat-green" id="massValue">0.0 kg</div>
                            <div class="stat-label">Masa Total del Sistema</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value stat-red" id="concValue">0.00 mg/L</div>
                            <div class="stat-label">Concentraci√≥n M√°xima Global</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value stat-yellow" id="spillValue">250 kg/s</div>
                            <div class="stat-label">Tasa de Descarga Industrial</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Controles de Par√°metros -->
            <section class="controls-section">
                <div class="control-panel">
                    <h3>üíß Par√°metros Hidrodin√°micos</h3>
                    
                    <div class="control-group">
                        <label id="velocityLabel">Velocidad del Flujo: 0.5 m/s</label>
                        <input type="range" min="0.2" max="2.0" step="0.1" value="0.5" id="velocitySlider" class="slider">
                    </div>

                    <div class="control-group">
                        <label id="diffXLabel">Coeficiente de Difusi√≥n Longitudinal: 0.012 m¬≤/s</label>
                        <input type="range" min="0.005" max="0.05" step="0.002" value="0.012" id="diffXSlider" class="slider">
                    </div>

                    <div class="control-group">
                        <label id="diffYLabel">Coeficiente de Difusi√≥n Transversal: 0.018 m¬≤/s</label>
                        <input type="range" min="0.005" max="0.05" step="0.002" value="0.018" id="diffYSlider" class="slider">
                    </div>
                </div>

                <div class="control-panel">
                    <h3>üè≠ Par√°metros de Descarga Industrial</h3>
                    
                    <div class="control-group">
                        <label id="spillRateLabel">Intensidad de Descarga: 250 kg/s</label>
                        <input type="range" min="50" max="500" step="25" value="250" id="spillRateSlider" class="slider">
                    </div>

                    <div class="control-group">
                        <label id="spillWidthLabel">Zona de Influencia desde Orilla: 20%</label>
                        <input type="range" min="10" max="40" step="5" value="20" id="spillWidthSlider" class="slider">
                    </div>
                </div>

                <div class="control-panel">
                    <h3>‚öóÔ∏è Procesos Biogeoqu√≠micos</h3>
                    
                    <div class="control-group">
                        <label id="degradationLabel">Coeficiente de Degradaci√≥n Biol√≥gica: 0.006 s‚Åª¬π</label>
                        <input type="range" min="0" max="0.05" step="0.002" value="0.006" id="degradationSlider" class="slider">
                    </div>

                    <div class="control-group">
                        <label id="reactionLabel">Coeficiente de Reacci√≥n Qu√≠mica: 0.002 s‚Åª¬π</label>
                        <input type="range" min="0" max="0.02" step="0.001" value="0.002" id="reactionSlider" class="slider">
                    </div>
                </div>
            </section>

            <!-- Informaci√≥n Acad√©mica -->
            <section class="info-section">
                <div class="info-panel">
                    <h3>üìê Formulaci√≥n Matem√°tica</h3>
                    <p><strong>Ecuaci√≥n de Advecci√≥n-Difusi√≥n-Reacci√≥n 2D:</strong></p>
                    <div class="equation">
                        ‚àÇC/‚àÇt + u‚àÇC/‚àÇx = Dx‚àÇ¬≤C/‚àÇx¬≤ + Dy‚àÇ¬≤C/‚àÇy¬≤ - (k‚ÇÅ+k‚ÇÇ)C + S(x,y,t)
                    </div>
                    <p style="font-size: 0.85rem; color: #a0aec0; line-height: 1.5;">
                        <strong>Donde:</strong> C = concentraci√≥n del contaminante, u = campo de velocidades, 
                        Dx,Dy = tensores de difusi√≥n, k‚ÇÅ,k‚ÇÇ = coeficientes de degradaci√≥n, S = t√©rmino fuente
                    </p>
                </div>

                <div class="info-panel">
                    <h3>üî¨ Fen√≥menos F√≠sicos Modelados</h3>
                    <ul class="phenomena-list">
                        <li>
                            <div class="phenomena-dot dot-green"></div>
                            <span><strong>Advecci√≥n:</strong> Transporte convectivo por el campo de velocidades del flujo</span>
                        </li>
                        <li>
                            <div class="phenomena-dot dot-blue"></div>
                            <span><strong>Difusi√≥n Molecular:</strong> Dispersi√≥n por gradientes de concentraci√≥n</span>
                        </li>
                        <li>
                            <div class="phenomena-dot dot-yellow"></div>
                            <span><strong>Degradaci√≥n Biol√≥gica:</strong> Eliminaci√≥n natural por procesos biogeoqu√≠micos</span>
                        </li>
                        <li>
                            <div class="phenomena-dot dot-red"></div>
                            <span><strong>Morfolog√≠a Asim√©trica:</strong> Pluma de contaminaci√≥n real√≠stica desde descarga lateral</span>
                        </li>
                    </ul>
                </div>
            </section>
        </main>

        <!-- Footer Acad√©mico -->
        <footer class="academic-footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>üéì Informaci√≥n Acad√©mica</h4>
                    <p><strong>Universidad Nacional de Cajamarca</strong></p>
                    <p>Departamento Acad√©mico de Matem√°tica</p>
                    <p>Investigaci√≥n en Matem√°tica Aplicada</p>
                    <p>Modelado Num√©rico y Simulaci√≥n Computacional</p>
                    <p style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(214, 158, 46, 0.3);">
                        <strong>üî¨ Desarrollador Principal:</strong><br>
                        Ever Rojas Huam√°n<br>
                        <em>Especialista en Matem√°tica Aplicada</em>
                    </p>
                </div>
                
                <div class="footer-section">
                    <h4>üî¨ Metodolog√≠a Cient√≠fica</h4>
                    <ul>
                        <li>M√©todo de Elementos Finitos</li>
                        <li>Formulaci√≥n D√©bil y Espacios de Sobolev</li>
                        <li>Discretizaci√≥n Espacial y Temporal</li>
                        <li>Esquemas Num√©ricos Estables</li>
                        <li>Validaci√≥n con Soluciones Anal√≠ticas</li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>üåç Aplicaciones</h4>
                    <ul>
                        <li>Gesti√≥n de Recursos H√≠dricos</li>
                        <li>Evaluaci√≥n de Impacto Ambiental</li>
                        <li>Ingenier√≠a Ambiental</li>
                        <li>Investigaci√≥n en Ciencias del Agua</li>
                    </ul>
                </div>
            </div>
            
            <div class="copyright">
                <p>¬© 2024 Universidad Nacional de Cajamarca - Departamento Acad√©mico de Matem√°tica</p>
                <p>Simulador de Transporte de Contaminantes | Desarrollado por <strong>Ever Rojas Huam√°n</strong></p>
                <p>Investigaci√≥n y Desarrollo en Matem√°tica Aplicada</p>
            </div>
        </footer>
    </div>

    <script>
        // ==========================================
        // SISTEMA DE GESTI√ìN DEL LOGO INSTITUCIONAL
        // ==========================================
        
        function handleLogoLoad(imgElement) {
            const logoContainer = document.getElementById('universityLogo');
            const fallback = document.getElementById('fallbackLogo');
            const status = document.getElementById('logoStatus');
            
            // Logo cargado exitosamente
            logoContainer.classList.remove('logo-loading', 'logo-error');
            logoContainer.classList.add('logo-loaded');
            fallback.style.display = 'none';
            imgElement.style.display = 'block';
            
            // Mostrar indicador de √©xito brevemente
            if (status) {
                status.style.background = '#48bb78';
                setTimeout(() => {
                    status.style.opacity = '0';
                }, 3000);
            }
        }
        
        function handleLogoError(imgElement) {
            const logoContainer = document.getElementById('universityLogo');
            const fallback = document.getElementById('fallbackLogo');
            const status = document.getElementById('logoStatus');
            
            // Error al cargar logo - usar fallback
            logoContainer.classList.remove('logo-loading', 'logo-loaded');
            logoContainer.classList.add('logo-error');
            imgElement.style.display = 'none';
            fallback.style.display = 'flex';
            
            // Intentar rutas alternativas
            tryAlternativeLogoPaths(imgElement);
            
            // Mostrar indicador de error
            if (status) {
                status.style.background = '#f56565';
                status.style.opacity = '1';
            }
        }
        
        function tryAlternativeLogoPaths(imgElement) {
            const alternativePaths = [
                '/logo-unc.png',
                'assets/logo-unc.png',
                'assets/images/logo-unc.png',
                'images/logo-unc.png',
                '../logo-unc.png'
            ];
            
            let pathIndex = 0;
            
            function tryNextPath() {
                if (pathIndex < alternativePaths.length) {
                    const testPath = alternativePaths[pathIndex];
                    
                    const testImg = new Image();
                    testImg.onload = function() {
                        imgElement.src = testPath;
                        handleLogoLoad(imgElement);
                    };
                    testImg.onerror = function() {
                        pathIndex++;
                        setTimeout(tryNextPath, 100);
                    };
                    testImg.src = testPath;
                } else {
                    // Mantener dise√±o alternativo
                }
            }
            
            setTimeout(tryNextPath, 500);
        }
        
        // Verificaci√≥n inicial del logo
        function initializeLogo() {
            const imgElement = document.getElementById('logoImage');
            const logoContainer = document.getElementById('universityLogo');
            
            if (!imgElement || !logoContainer) return;
            
            // Configurar evento de timeout para el logo
            const logoTimeout = setTimeout(() => {
                if (!logoContainer.classList.contains('logo-loaded')) {
                    handleLogoError(imgElement);
                }
            }, 5000);
            
            // Limpiar timeout si el logo carga correctamente
            imgElement.addEventListener('load', () => {
                clearTimeout(logoTimeout);
            });
        }

        // ==========================================
        // SIMULADOR PRINCIPAL
        // ==========================================
        
        // Variables globales
        let canvas = null;
        let ctx = null;
        let isRunning = false;
        let time = 0;
        let maxConcentration = 0;
        let totalMass = 0;
        let animationId = null;

        // Variables para an√°lisis de concentraci√≥n
        let concentrationMode = 'point';
        let analysisActive = false;
        let selectedPoint = { x: 0, y: 0 };
        let pointConcentration = 0;
        let hasSelectedPoint = false;

        // Par√°metros del modelo
        let params = {
            velocity: 0.5,
            diffusionX: 0.012,
            diffusionY: 0.018,
            degradation: 0.006,
            reaction: 0.002,
            spillRate: 250,
            spillPosition: 0.02,
            spillWidth: 0.2
        };

        // Configuraci√≥n num√©rica
        const channelLength = 100;
        const channelWidth = 20;
        const gridX = 80;
        const gridY = 40;
        const dx = channelLength / gridX;
        const dy = channelWidth / gridY;
        const dt = 0.01; // Paso de tiempo m√°s realista (1 cent√©sima de segundo)
        
        // Control de tiempo real
        let lastUpdateTime = 0;
        const updateInterval = 100; // Actualizar cada 100ms (10 veces por segundo)

        // Matrices de concentraci√≥n
        let concentration = Array(gridY).fill().map(() => Array(gridX).fill(0));
        let newConcentration = Array(gridY).fill().map(() => Array(gridX).fill(0));

        // Inicializaci√≥n del simulador
        function init() {
            try {
                canvas = document.getElementById('simulationCanvas');
                ctx = canvas.getContext('2d');
                canvas.width = 1000;
                canvas.height = 600;
                
                initializeLogo();
                setupEventListeners();
                setupSliders();
                setupConcentrationAnalysis();
                draw();
                resizeCanvas();
                
            } catch (error) {
                alert('Error de inicializaci√≥n: ' + error.message);
            }
        }

        function setupEventListeners() {
            try {
                const startBtn = document.getElementById('startBtn');
                const resetBtn = document.getElementById('resetBtn');
                const concentrationBtn = document.getElementById('concentrationBtn');
                
                if (!startBtn || !resetBtn || !concentrationBtn) {
                    throw new Error('Botones de control no encontrados');
                }
                
                startBtn.addEventListener('click', toggleSimulation);
                resetBtn.addEventListener('click', resetSimulation);
                concentrationBtn.addEventListener('click', toggleConcentrationAnalysis);
                window.addEventListener('resize', resizeCanvas);
                
            } catch (error) {
                throw new Error('Error configurando eventos: ' + error.message);
            }
        }

        function setupConcentrationAnalysis() {
            // Configurar botones de modo
            const modeButtons = document.querySelectorAll('.mode-btn');
            modeButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    modeButtons.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    concentrationMode = e.target.dataset.mode;
                    updateConcentrationInstructions();
                    // Limpiar selecci√≥n al cambiar modo
                    clearSelectedPoint();
                });
            });

            // Configurar bot√≥n de limpiar selecci√≥n
            const clearBtn = document.getElementById('clearPointBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearSelectedPoint);
            }

            // Configurar clics en el canvas
            canvas.addEventListener('click', handleCanvasClick);
        }

        function toggleConcentrationAnalysis() {
            analysisActive = !analysisActive;
            const panel = document.getElementById('concentrationPanel');
            const btn = document.getElementById('concentrationBtn');
            
            if (analysisActive) {
                panel.style.display = 'block';
                btn.textContent = 'üìä Ocultar An√°lisis';
                btn.className = 'btn btn-danger';
                canvas.style.cursor = 'crosshair';
                updateConcentrationInstructions();
            } else {
                panel.style.display = 'none';
                btn.textContent = 'üìä An√°lisis C(x,y,t)';
                btn.className = 'btn btn-info';
                canvas.style.cursor = 'default';
                clearSelectedPoint();
            }
        }

        function updateConcentrationInstructions() {
            const modeText = document.getElementById('currentModeText');
            const instructionText = document.getElementById('instructionText');
            
            const modes = {
                point: {
                    name: 'Consulta Puntual',
                    instruction: 'Haga clic en cualquier punto del dominio para fijar la selecci√≥n y obtener el valor de concentraci√≥n C(x,y,t) en esa ubicaci√≥n. El punto seleccionado se mantiene fijo hasta hacer clic en otro lugar.'
                },
                profile: {
                    name: 'Perfil Longitudinal',
                    instruction: 'Haga clic para obtener el perfil de concentraci√≥n a lo largo de la direcci√≥n x (flujo principal) en la coordenada y seleccionada.'
                },
                cross: {
                    name: 'Perfil Transversal',
                    instruction: 'Haga clic para obtener el perfil de concentraci√≥n a lo largo de la direcci√≥n y (transversal al flujo) en la coordenada x seleccionada.'
                }
            };
            
            modeText.textContent = modes[concentrationMode].name;
            instructionText.textContent = modes[concentrationMode].instruction;
        }

        function clearSelectedPoint() {
            hasSelectedPoint = false;
            selectedPoint = { x: 0, y: 0 };
            pointConcentration = 0;
            const overlay = document.getElementById('concentrationOverlay');
            overlay.classList.remove('active');
            updateConcentrationDisplay();
        }

        function handleCanvasClick(event) {
            if (!analysisActive) return;
            
            const rect = canvas.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;
            
            // Convertir coordenadas del canvas a coordenadas del dominio
            const { domainCoords, gridCoords } = canvasToGridCoordinates(clickX, clickY);
            
            if (gridCoords.i >= 0 && gridCoords.i < gridX && gridCoords.j >= 0 && gridCoords.j < gridY) {
                selectedPoint = domainCoords;
                pointConcentration = concentration[gridCoords.j][gridCoords.i];
                hasSelectedPoint = true;
                
                updateConcentrationDisplay();
                updateConcentrationOverlay(domainCoords, pointConcentration);
                showConcentrationOverlay();
                
                // Feedback visual y sonoro
                canvas.style.cursor = 'grab';
                setTimeout(() => {
                    if (analysisActive) canvas.style.cursor = 'crosshair';
                }, 200);
            }
        }

        function showConcentrationOverlay() {
            const overlay = document.getElementById('concentrationOverlay');
            overlay.classList.add('active');
        }

        function canvasToGridCoordinates(canvasX, canvasY) {
            const width = canvas.width || 1000;
            const height = canvas.height || 600;
            
            const isMobile = width < 768;
            const simWidth = Math.max(width * (isMobile ? 0.9 : 0.85), 200);
            const simHeight = Math.max(height * 0.65, 150);
            const offsetX = (width - simWidth) / 2;
            const offsetY = height * 0.12;
            
            // Verificar si el clic est√° dentro del √°rea de simulaci√≥n
            if (canvasX < offsetX || canvasX > offsetX + simWidth || 
                canvasY < offsetY || canvasY > offsetY + simHeight) {
                return { domainCoords: null, gridCoords: { i: -1, j: -1 } };
            }
            
            // Convertir a coordenadas relativas dentro del √°rea de simulaci√≥n
            const relativeX = (canvasX - offsetX) / simWidth;
            const relativeY = (canvasY - offsetY) / simHeight;
            
            // Convertir a coordenadas de la malla
            const i = Math.floor(relativeX * gridX);
            const j = Math.floor(relativeY * gridY);
            
            // Convertir a coordenadas del dominio f√≠sico
            const x = relativeX * channelLength;
            const y = relativeY * channelWidth;
            
            return {
                domainCoords: { x, y },
                gridCoords: { i, j }
            };
        }

        function updateConcentrationDisplay() {
            // No se necesita actualizar tarjeta adicional ya que solo usamos el overlay
            if (analysisActive && hasSelectedPoint) {
                updateConcentrationOverlay(selectedPoint, pointConcentration);
            }
        }

        function showConcentrationOverlay(canvasX, canvasY) {
            const overlay = document.getElementById('concentrationOverlay');
            overlay.classList.add('active');
        }

        function updateConcentrationOverlay(coords, concentration) {
            const pointConcentrationElement = document.getElementById('pointConcentration');
            const pointCoordinatesElement = document.getElementById('pointCoordinates');
            const pointTimeElement = document.getElementById('pointTime');
            
            if (pointConcentrationElement && pointCoordinatesElement && pointTimeElement && coords) {
                pointConcentrationElement.textContent = (concentration * 1000).toFixed(3) + ' mg/L';
                pointCoordinatesElement.textContent = `x: ${coords.x.toFixed(1)}m, y: ${coords.y.toFixed(1)}m`;
                pointTimeElement.textContent = `t: ${time.toFixed(1)}s`;
            }
        }

        function setupSliders() {
            const sliders = [
                { id: 'velocitySlider', param: 'velocity', label: 'velocityLabel', unit: ' m/s', prefix: 'Velocidad del Flujo: ' },
                { id: 'diffXSlider', param: 'diffusionX', label: 'diffXLabel', unit: ' m¬≤/s', prefix: 'Coeficiente de Difusi√≥n Longitudinal: ' },
                { id: 'diffYSlider', param: 'diffusionY', label: 'diffYLabel', unit: ' m¬≤/s', prefix: 'Coeficiente de Difusi√≥n Transversal: ' },
                { id: 'spillRateSlider', param: 'spillRate', label: 'spillRateLabel', unit: ' kg/s', prefix: 'Intensidad de Descarga: ' },
                { id: 'spillWidthSlider', param: 'spillWidth', label: 'spillWidthLabel', unit: '%', prefix: 'Zona de Influencia desde Orilla: ', multiplier: 100, divider: 100 },
                { id: 'degradationSlider', param: 'degradation', label: 'degradationLabel', unit: ' s‚Åª¬π', prefix: 'Coeficiente de Degradaci√≥n Biol√≥gica: ' },
                { id: 'reactionSlider', param: 'reaction', label: 'reactionLabel', unit: ' s‚Åª¬π', prefix: 'Coeficiente de Reacci√≥n Qu√≠mica: ' }
            ];

            sliders.forEach(slider => {
                const element = document.getElementById(slider.id);
                const label = document.getElementById(slider.label);
                
                if (element && label) {
                    element.addEventListener('input', (e) => {
                        let value = parseFloat(e.target.value);
                        if (slider.divider) value /= slider.divider;
                        
                        params[slider.param] = value;
                        
                        let displayValue = slider.multiplier ? value * slider.multiplier : value;
                        label.textContent = slider.prefix + displayValue.toFixed(3) + slider.unit;
                        
                        if (slider.param === 'spillRate') {
                            const spillValueElement = document.getElementById('spillValue');
                            if (spillValueElement) {
                                spillValueElement.textContent = displayValue + ' kg/s';
                            }
                        }
                    });
                }
            });
        }

        function toggleSimulation() {
            isRunning = !isRunning;
            const startBtn = document.getElementById('startBtn');
            
            if (startBtn) {
                if (isRunning) {
                    startBtn.textContent = '‚è∏Ô∏è Pausar Simulaci√≥n';
                    startBtn.className = 'btn btn-danger';
                    lastUpdateTime = performance.now(); // Inicializar tiempo de referencia
                    animationId = requestAnimationFrame(animate);
                } else {
                    startBtn.textContent = '‚ñ∂Ô∏è Iniciar Simulaci√≥n';
                    startBtn.className = 'btn btn-primary';
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                    }
                }
            }
        }

        function resetSimulation() {
            isRunning = false;
            time = 0;
            maxConcentration = 0;
            totalMass = 0;
            
            // Limpiar selecci√≥n de punto
            clearSelectedPoint();
            
            concentration = Array(gridY).fill().map(() => Array(gridX).fill(0));
            newConcentration = Array(gridY).fill().map(() => Array(gridX).fill(0));
            
            updateStats();
            updateConcentrationDisplay();
            draw();
            
            const startBtn = document.getElementById('startBtn');
            if (startBtn) {
                startBtn.textContent = '‚ñ∂Ô∏è Iniciar Simulaci√≥n';
                startBtn.className = 'btn btn-primary';
            }
            
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }

        function animate(currentTime) {
            if (!isRunning) return;
            
            // Control de tiempo real: actualizar solo cada updateInterval milisegundos
            if (currentTime - lastUpdateTime >= updateInterval) {
                // Realizar m√∫ltiples pasos peque√±os para estabilidad num√©rica
                for (let step = 0; step < 10; step++) {
                    updateConcentration();
                    time += dt;
                }
                
                updateStats();
                updateConcentrationDisplay();
                draw();
                
                lastUpdateTime = currentTime;
            }
            
            animationId = requestAnimationFrame(animate);
        }

        function updateConcentration() {
            const u = params.velocity;
            const Dx = params.diffusionX;
            const Dy = params.diffusionY;
            const k1 = params.degradation;
            const k2 = params.reaction;
            const spillX = Math.floor(params.spillPosition * gridX);
            const maxSpillDepth = Math.floor(params.spillWidth * gridY);
            
            let currentMax = 0;
            let mass = 0;
            
            for (let j = 0; j < gridY; j++) {
                for (let i = 0; i < gridX; i++) {
                    let advectionX = 0;
                    let diffusionX = 0;
                    let diffusionY = 0;
                    let source = 0;
                    let reaction = -(k1 + k2) * concentration[j][i];
                    
                    const distanceFromNorth = j / (gridY - 1);
                    const distanceFromSouth = (gridY - 1 - j) / (gridY - 1);
                    const shoreEffect = Math.min(distanceFromNorth, distanceFromSouth);
                    const velocityProfile = 0.3 + 0.7 * (4 * shoreEffect * (1 - shoreEffect));
                    const localVelocity = u * velocityProfile;
                    
                    if (i > 0) {
                        advectionX = -localVelocity * (concentration[j][i] - concentration[j][i-1]) / dx;
                    }
                    
                    if (i > 0 && i < gridX - 1) {
                        diffusionX = Dx * (concentration[j][i+1] - 2*concentration[j][i] + concentration[j][i-1]) / (dx * dx);
                    }
                    
                    const mixingIntensity = 1 + 2 * shoreEffect;
                    const localDiffusionY = Dy * mixingIntensity;
                    
                    if (j > 0 && j < gridY - 1) {
                        diffusionY = localDiffusionY * (concentration[j+1][i] - 2*concentration[j][i] + concentration[j-1][i]) / (dy * dy);
                    }
                    
                    if (i === spillX && j <= maxSpillDepth) {
                        const distanceFromShore = j / maxSpillDepth;
                        const sourceIntensity = params.spillRate * (1 - distanceFromShore * 0.8);
                        source = sourceIntensity / (dx * dy);
                    }
                    
                    newConcentration[j][i] = concentration[j][i] + dt * (advectionX + diffusionX + diffusionY + reaction + source);
                    
                    if (newConcentration[j][i] < 0) newConcentration[j][i] = 0;
                    
                    if (j === 0) {
                        newConcentration[j][i] = Math.max(0, newConcentration[j][i] * 0.95);
                    } else if (j === gridY - 1) {
                        newConcentration[j][i] = Math.max(0, newConcentration[j][i] * 0.85);
                    }
                    
                    currentMax = Math.max(currentMax, newConcentration[j][i]);
                    mass += newConcentration[j][i] * dx * dy;
                }
            }
            
            [concentration, newConcentration] = [newConcentration, concentration];
            maxConcentration = Math.max(maxConcentration, currentMax);
            totalMass = mass;
            
            // Actualizar concentraci√≥n en el punto seleccionado
            if (analysisActive && hasSelectedPoint) {
                const relativeX = selectedPoint.x / channelLength;
                const relativeY = selectedPoint.y / channelWidth;
                const i = Math.floor(relativeX * gridX);
                const j = Math.floor(relativeY * gridY);
                
                if (i >= 0 && i < gridX && j >= 0 && j < gridY) {
                    pointConcentration = concentration[j][i];
                }
            }
        }

        function updateStats() {
            const timeElement = document.getElementById('timeValue');
            const massElement = document.getElementById('massValue');
            const concElement = document.getElementById('concValue');
            
            if (timeElement) timeElement.textContent = time.toFixed(1) + 's';
            if (massElement) massElement.textContent = totalMass.toFixed(1) + ' kg';
            if (concElement) concElement.textContent = (maxConcentration * 1000).toFixed(2) + ' mg/L';
        }

        function draw() {
            if (!ctx || !canvas) return;
            
            try {
                const width = canvas.width || 1000;
                const height = canvas.height || 600;
                
                if (width <= 0 || height <= 0) return;
                
                // Fondo
                const bgGradient = ctx.createLinearGradient(0, 0, 0, height);
                bgGradient.addColorStop(0, '#0f1419');
                bgGradient.addColorStop(0.3, '#1a202c');
                bgGradient.addColorStop(1, '#2d3748');
                
                ctx.fillStyle = bgGradient;
                ctx.fillRect(0, 0, width, height);
                
                // Calcular dimensiones de simulaci√≥n
                const isMobile = width < 768;
                const simWidth = Math.max(width * (isMobile ? 0.9 : 0.85), 200);
                const simHeight = Math.max(height * 0.65, 150);
                const offsetX = (width - simWidth) / 2;
                const offsetY = height * 0.12;
                
                // Dibujar canal
                drawChannelWater(offsetX, offsetY, simWidth, simHeight);
                
                // Marco del canal
                ctx.strokeStyle = 'rgba(214, 158, 46, 0.8)';
                ctx.lineWidth = 3;
                ctx.strokeRect(offsetX, offsetY, simWidth, simHeight);
                
                // Pluma de contaminaci√≥n
                const cellWidth = simWidth / gridX;
                const cellHeight = simHeight / gridY;
                drawContaminantPlume(offsetX, offsetY, cellWidth, cellHeight);
                
                // Industria
                drawIndustry(offsetX, offsetY);
                
                // Punto de descarga
                if (isRunning || maxConcentration > 0) {
                    drawDischarge(offsetX, offsetY, simWidth);
                }
                
                // Flechas de flujo
                drawFlowArrows(offsetX, offsetY, simWidth, simHeight);
                
                // Punto seleccionado para an√°lisis
                if (analysisActive && hasSelectedPoint) {
                    drawSelectedPoint(offsetX, offsetY, simWidth, simHeight);
                }
                
                // Etiquetas con logo UNC
                drawLabels(offsetX, offsetY, simWidth);
                
            } catch (error) {
                // Silencioso para evitar spam en console
            }
        }

        function drawSelectedPoint(offsetX, offsetY, simWidth, simHeight) {
            const relativeX = selectedPoint.x / channelLength;
            const relativeY = selectedPoint.y / channelWidth;
            
            const pointX = offsetX + relativeX * simWidth;
            const pointY = offsetY + relativeY * simHeight;
            
            // C√≠rculo de selecci√≥n
            ctx.beginPath();
            ctx.arc(pointX, pointY, 8, 0, 2 * Math.PI);
            ctx.strokeStyle = '#63b3ed';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.beginPath();
            ctx.arc(pointX, pointY, 4, 0, 2 * Math.PI);
            ctx.fillStyle = '#63b3ed';
            ctx.fill();
            
            // Crosshair
            ctx.strokeStyle = 'rgba(99, 179, 237, 0.7)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            ctx.beginPath();
            ctx.moveTo(offsetX, pointY);
            ctx.lineTo(offsetX + simWidth, pointY);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(pointX, offsetY);
            ctx.lineTo(pointX, offsetY + simHeight);
            ctx.stroke();
            
            ctx.setLineDash([]);
        }

        function drawChannelWater(offsetX, offsetY, simWidth, simHeight) {
            if (!ctx || simWidth <= 0 || simHeight <= 0) return;
            
            try {
                const waterGradient = ctx.createLinearGradient(0, offsetY, 0, offsetY + simHeight);
                waterGradient.addColorStop(0, '#2b77cb');
                waterGradient.addColorStop(0.3, '#2563eb');
                waterGradient.addColorStop(0.7, '#1d4ed8');
                waterGradient.addColorStop(1, '#1e3a8a');
                
                ctx.fillStyle = waterGradient;
                ctx.fillRect(offsetX, offsetY, simWidth, simHeight);
                
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.lineWidth = 1;
                
                for (let i = 0; i < 8; i++) {
                    ctx.beginPath();
                    const waveY = offsetY + (i + 1) * simHeight / 9;
                    const amplitude = 1.5;
                    const frequency = 0.012;
                    const phase = Date.now() * 0.0005 + i * 0.4;
                    
                    for (let x = 0; x <= simWidth; x += 4) {
                        const y = waveY + amplitude * Math.sin(frequency * x + phase);
                        if (x === 0) {
                            ctx.moveTo(offsetX + x, y);
                        } else {
                            ctx.lineTo(offsetX + x, y);
                        }
                    }
                    ctx.stroke();
                }
            } catch (error) {
                // Silencioso
            }
        }

        function drawContaminantPlume(offsetX, offsetY, cellWidth, cellHeight) {
            for (let j = 0; j < gridY; j++) {
                for (let i = 0; i < gridX; i++) {
                    const conc = concentration[j][i];
                    const normalizedConc = maxConcentration > 0 ? Math.min(conc / maxConcentration, 1) : 0;
                    
                    if (normalizedConc > 0.008) {
                        const x = offsetX + i * cellWidth;
                        const y = offsetY + j * cellHeight;
                        
                        let red, green, blue, alpha;
                        
                        if (normalizedConc > 0.9) {
                            red = 180; green = 20; blue = 20; alpha = 0.9;
                        } else if (normalizedConc > 0.7) {
                            red = 220; green = 50; blue = 30; alpha = 0.8;
                        } else if (normalizedConc > 0.5) {
                            red = 255; green = 100; blue = 40; alpha = 0.7;
                        } else if (normalizedConc > 0.3) {
                            red = 255; green = 160; blue = 60; alpha = 0.6;
                        } else if (normalizedConc > 0.15) {
                            red = 255; green = 200; blue = 100; alpha = 0.5;
                        } else {
                            red = 255; green = 240; blue = 180; alpha = 0.35;
                        }
                        
                        const gradient = ctx.createRadialGradient(
                            x + cellWidth/2, y + cellHeight/2, 0,
                            x + cellWidth/2, y + cellHeight/2, cellWidth * 0.9
                        );
                        
                        gradient.addColorStop(0, `rgba(${red}, ${green}, ${blue}, ${alpha})`);
                        gradient.addColorStop(1, `rgba(${red}, ${green}, ${blue}, ${alpha * 0.2})`);
                        
                        ctx.fillStyle = gradient;
                        ctx.fillRect(x, y, cellWidth, cellHeight);
                    }
                }
            }
        }

        function drawIndustry(offsetX, offsetY) {
            const industryX = offsetX - 60;
            const industryY = offsetY - 90;
            
            const buildingGradient = ctx.createLinearGradient(industryX, industryY, industryX, industryY + 70);
            buildingGradient.addColorStop(0, '#4a5568');
            buildingGradient.addColorStop(0.5, '#2d3748');
            buildingGradient.addColorStop(1, '#1a202c');
            
            ctx.fillStyle = buildingGradient;
            ctx.fillRect(industryX, industryY, 50, 70);
            ctx.fillRect(industryX + 55, industryY + 25, 35, 45);
            
            ctx.fillStyle = '#fbbf24';
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 5; j++) {
                    ctx.fillRect(industryX + 6 + i * 14, industryY + 8 + j * 12, 8, 9);
                }
            }
            
            for (let i = 0; i < 2; i++) {
                for (let j = 0; j < 3; j++) {
                    ctx.fillRect(industryX + 60 + i * 12, industryY + 30 + j * 12, 7, 8);
                }
            }
            
            ctx.fillStyle = '#2d3748';
            ctx.fillRect(industryX + 15, industryY + 60, 20, 10);
            ctx.fillRect(industryX + 65, industryY + 60, 15, 10);
            
            ctx.fillStyle = '#d69e2e';
            ctx.font = 'bold 8px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('INDUSTRIA', industryX + 45, industryY - 5);
            
            if (isRunning) {
                for (let i = 0; i < 3; i++) {
                    drawSmoke(industryX + 10 + i * 30, industryY - 15, i * 0.3);
                }
            }
        }

        function drawSmoke(x, y, phase) {
            const time = Date.now() * 0.003 + phase;
            ctx.fillStyle = 'rgba(150, 150, 150, 0.7)';
            
            for (let i = 0; i < 8; i++) {
                const smokeY = y - i * 8;
                const smokeX = x + Math.sin(time + i * 0.5) * (i + 1) * 2;
                const size = Math.max(1, 4 - i * 0.3);
                
                ctx.beginPath();
                ctx.arc(smokeX, smokeY, size, 0, 2 * Math.PI);
                ctx.fill();
            }
        }

        function drawDischarge(offsetX, offsetY, simWidth) {
            const dischargeX = offsetX + params.spillPosition * simWidth;
            const dischargeHeight = params.spillWidth * 60;
            
            if (isRunning) {
                const intensity = Math.sin(Date.now() * 0.01) * 0.3 + 0.7;
                
                const dischargeGradient = ctx.createLinearGradient(
                    dischargeX - 20, offsetY,
                    dischargeX + 20, offsetY + dischargeHeight
                );
                dischargeGradient.addColorStop(0, `rgba(255, 100, 100, ${intensity * 0.8})`);
                dischargeGradient.addColorStop(0.5, `rgba(255, 200, 100, ${intensity * 0.6})`);
                dischargeGradient.addColorStop(1, `rgba(255, 255, 200, ${intensity * 0.3})`);
                
                ctx.fillStyle = dischargeGradient;
                
                for (let i = 0; i < 5; i++) {
                    const streamX = dischargeX + (Math.random() - 0.5) * 8;
                    const streamWidth = 3 + Math.random() * 3;
                    ctx.fillRect(streamX, offsetY, streamWidth, dischargeHeight);
                }
                
                const pulseGradient = ctx.createRadialGradient(
                    dischargeX, offsetY + 10, 0,
                    dischargeX, offsetY + 10, 25
                );
                pulseGradient.addColorStop(0, `rgba(255, 100, 100, ${intensity * 0.6})`);
                pulseGradient.addColorStop(1, 'rgba(255, 100, 100, 0)');
                
                ctx.fillStyle = pulseGradient;
                ctx.beginPath();
                ctx.arc(dischargeX, offsetY + 10, 25, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            ctx.strokeStyle = '#e53e3e';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(dischargeX, offsetY);
            ctx.lineTo(dischargeX, offsetY + dischargeHeight);
            ctx.stroke();
            
            ctx.fillStyle = '#e53e3e';
            ctx.font = 'bold 10px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('DESCARGA', dischargeX, offsetY - 8);
        }

        function drawFlowArrows(offsetX, offsetY, simWidth, simHeight) {
            ctx.strokeStyle = 'rgba(99, 179, 237, 0.7)';
            ctx.fillStyle = 'rgba(99, 179, 237, 0.7)';
            ctx.lineWidth = 2;
            
            const arrowSpacing = 100;
            const arrowLength = 30;
            const arrowHeight = 8;
            
            for (let x = offsetX + 50; x < offsetX + simWidth - 50; x += arrowSpacing) {
                for (let y = offsetY + 40; y < offsetY + simHeight - 40; y += 60) {
                    const relativeY = (y - offsetY) / simHeight;
                    const distanceFromCenter = Math.abs(relativeY - 0.5) * 2;
                    const velocityFactor = 0.5 + 0.5 * (1 - distanceFromCenter);
                    const currentArrowLength = arrowLength * velocityFactor;
                    
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x + currentArrowLength, y);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(x + currentArrowLength, y);
                    ctx.lineTo(x + currentArrowLength - 8, y - arrowHeight/2);
                    ctx.lineTo(x + currentArrowLength - 8, y + arrowHeight/2);
                    ctx.closePath();
                    ctx.fill();
                }
            }
        }

        function drawLabels(offsetX, offsetY, simWidth) {
            ctx.fillStyle = '#f7fafc';
            ctx.font = 'bold 12px sans-serif';
            ctx.textAlign = 'left';
            
            ctx.fillText('üèõÔ∏è UNC - Matem√°tica Aplicada', offsetX, offsetY - 25);
            
            ctx.font = '10px sans-serif';
            ctx.fillStyle = '#a0aec0';
            ctx.textAlign = 'right';
            ctx.fillText('Flujo ‚Üí', offsetX + simWidth - 10, offsetY + 20);
            
            ctx.textAlign = 'left';
            ctx.save();
            ctx.translate(offsetX - 15, offsetY + 40);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('‚Üê Orilla Norte', 0, 0);
            ctx.restore();
            
            ctx.save();
            ctx.translate(offsetX - 15, offsetY + simWidth * 0.4);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Orilla Sur ‚Üí', 0, 0);
            ctx.restore();
        }

        function resizeCanvas() {
            if (!canvas) return;
            
            try {
                const container = canvas.parentElement;
                if (!container) return;
                
                const containerWidth = container.clientWidth - 48;
                const containerHeight = Math.min(600, window.innerHeight * 0.6);
                
                canvas.style.width = containerWidth + 'px';
                canvas.style.height = containerHeight + 'px';
                
                const scale = window.devicePixelRatio || 1;
                canvas.width = containerWidth * scale;
                canvas.height = containerHeight * scale;
                
                if (ctx) {
                    ctx.scale(scale, scale);
                }
                
                draw();
            } catch (error) {
                // Silencioso
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>